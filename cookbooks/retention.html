<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Retention - Firefox Data Documentation</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../dtmo.css">
        
        <link rel="stylesheet" href="../mermaid.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../introduction.html">Firefox Data Documentation</a></li><li class="expanded "><a href="../concepts/reporting_a_problem.html"><strong aria-hidden="true">1.</strong> Reporting a problem</a></li><li class="expanded "><a href="../concepts/terminology.html"><strong aria-hidden="true">2.</strong> Terminology</a></li><li class="expanded "><a href="../concepts/getting_started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/analysis_intro.html"><strong aria-hidden="true">3.1.</strong> Analysis Quick Start</a></li><li class="expanded "><a href="../concepts/choosing_a_dataset.html"><strong aria-hidden="true">3.2.</strong> Choosing a Desktop Dataset</a></li><li class="expanded "><a href="../concepts/choosing_a_dataset_mobile.html"><strong aria-hidden="true">3.3.</strong> Choosing a Mobile Dataset</a></li><li class="expanded "><a href="../tools/stmo.html"><strong aria-hidden="true">3.4.</strong> Intro to STMO</a></li><li class="expanded "><a href="../concepts/analysis_gotchas.html"><strong aria-hidden="true">3.5.</strong> Common Analysis Gotchas</a></li><li class="expanded "><a href="../concepts/sql_optimization.html"><strong aria-hidden="true">3.6.</strong> Optimizing Queries</a></li><li class="expanded "><a href="../concepts/getting_help.html"><strong aria-hidden="true">3.7.</strong> Getting Help</a></li></ol></li><li class="expanded "><a href="../tools/index.html"><strong aria-hidden="true">4.</strong> Tools</a></li><li><ol class="section"><li class="expanded "><a href="../tools/projects.html"><strong aria-hidden="true">4.1.</strong> Project Glossary</a></li><li class="expanded "><a href="../concepts/pipeline/data_pipeline.html"><strong aria-hidden="true">4.2.</strong> Overview of Mozilla's Data Pipeline</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/pipeline/data_pipeline_detail.html"><strong aria-hidden="true">4.2.1.</strong> In-depth Data Pipeline Detail</a></li><li class="expanded "><a href="../concepts/pipeline/http_edge_spec.html"><strong aria-hidden="true">4.2.2.</strong> HTTP Edge Server Specification</a></li><li class="expanded "><a href="../concepts/pipeline/event_pipeline.html"><strong aria-hidden="true">4.2.3.</strong> Event Pipeline Detail</a></li></ol></li><li class="expanded "><a href="../tools/interfaces.html"><strong aria-hidden="true">4.3.</strong> Analysis Interfaces</a></li><li class="expanded "><a href="../tools/spark.html"><strong aria-hidden="true">4.4.</strong> Custom analysis with Spark</a></li><li class="expanded "><a href="../concepts/sql_style.html"><strong aria-hidden="true">4.5.</strong> SQL Style Guide</a></li><li class="expanded "><a href="../concepts/glean/glean.html"><strong aria-hidden="true">4.6.</strong> Glean overview</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/glean/debug_ping_view.html"><strong aria-hidden="true">4.6.1.</strong> Glean Debug ping viewer</a></li></ol></li><li class="expanded "><a href="../tools/alerts.html"><strong aria-hidden="true">4.7.</strong> Alerts</a></li></ol></li><li class="expanded "><a href="../cookbooks/index.html"><strong aria-hidden="true">5.</strong> Analysis cookbooks</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/bigquery.html"><strong aria-hidden="true">5.1.</strong> Accessing and working with BigQuery</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/bigquery-airflow.html"><strong aria-hidden="true">5.1.1.</strong> Scheduling BigQuery Queries in Airflow</a></li></ol></li><li class="expanded "><a href="../cookbooks/dataset_specific.html"><strong aria-hidden="true">5.2.</strong> Dataset Specific</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/crash_pings.html"><strong aria-hidden="true">5.2.1.</strong> Working with Crash Pings</a></li><li class="expanded "><a href="../cookbooks/normandy_events.html"><strong aria-hidden="true">5.2.2.</strong> Working with Normandy events</a></li></ol></li><li class="expanded "><a href="../cookbooks/realtime.html"><strong aria-hidden="true">5.3.</strong> Real-time</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/realtime_analysis_plugin.html"><strong aria-hidden="true">5.3.1.</strong> Creating a Real-time Analysis Plugin</a></li><li class="expanded "><a href="../cookbooks/view_pings_cep.html"><strong aria-hidden="true">5.3.2.</strong> Seeing Your Own Pings</a></li><li class="expanded "><a href="../tools/cep_matcher.html"><strong aria-hidden="true">5.3.3.</strong> CEP Matcher</a></li></ol></li><li class="expanded "><a href="../cookbooks/metrics.html"><strong aria-hidden="true">5.4.</strong> Metrics</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/dau.html"><strong aria-hidden="true">5.4.1.</strong> Daily Active Users (DAU)</a></li><li class="expanded "><a href="../cookbooks/active_dau.html"><strong aria-hidden="true">5.4.2.</strong> Active DAU (aDAU)</a></li><li class="expanded "><a href="../cookbooks/retention.html" class="active"><strong aria-hidden="true">5.4.3.</strong> Retention</a></li></ol></li></ol></li><li class="expanded "><a href="../datasets/new_data.html"><strong aria-hidden="true">6.</strong> Sending telemetry</a></li><li><ol class="section"><li class="expanded "><a href="../cookbooks/client_guidelines.html"><strong aria-hidden="true">6.1.</strong> Implementing Experiments</a></li><li class="expanded "><a href="../cookbooks/events_best_practices.html"><strong aria-hidden="true">6.2.</strong> Sending Events</a></li><li class="expanded "><a href="../cookbooks/new_ping.html"><strong aria-hidden="true">6.3.</strong> Sending a Custom Ping</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="../datasets/reference.html"><strong aria-hidden="true">7.</strong> Dataset Reference</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/pings.html"><strong aria-hidden="true">7.1.</strong> Pings</a></li><li class="expanded "><a href="../datasets/derived.html"><strong aria-hidden="true">7.2.</strong> Derived Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/active_profiles.html"><strong aria-hidden="true">7.2.1.</strong> Active Profiles</a></li><li class="expanded "><a href="../datasets/batch_view/addons/reference.html"><strong aria-hidden="true">7.2.2.</strong> Addons</a></li><li class="expanded "><a href="../datasets/other/addons_daily/reference.html"><strong aria-hidden="true">7.2.3.</strong> Addons Daily</a></li><li class="expanded "><a href="../datasets/batch_view/clients_daily/reference.html"><strong aria-hidden="true">7.2.4.</strong> Clients Daily</a></li><li class="expanded "><a href="../datasets/bigquery/clients_last_seen/reference.html"><strong aria-hidden="true">7.2.5.</strong> Clients Last Seen</a></li><li class="expanded "><a href="../datasets/batch_view/crash_summary/reference.html"><strong aria-hidden="true">7.2.6.</strong> Crash Summary</a></li><li class="expanded "><a href="../datasets/batch_view/cross_sectional/reference.html"><strong aria-hidden="true">7.2.7.</strong> Cross Sectional</a></li><li class="expanded "><a href="../datasets/streaming/error_aggregates/reference.html"><strong aria-hidden="true">7.2.8.</strong> Error Aggregates</a></li><li class="expanded "><a href="../datasets/batch_view/events/reference.html"><strong aria-hidden="true">7.2.9.</strong> Events</a></li><li class="expanded "><a href="../datasets/bigquery/exact_mau/reference.html"><strong aria-hidden="true">7.2.10.</strong> Exact MAU</a></li><li class="expanded "><a href="../datasets/batch_view/first_shutdown_summary/reference.html"><strong aria-hidden="true">7.2.11.</strong> First Shutdown Summary</a></li><li class="expanded "><a href="../datasets/batch_view/longitudinal/reference.html"><strong aria-hidden="true">7.2.12.</strong> Longitudinal</a></li><li class="expanded "><a href="../datasets/batch_view/main_summary/reference.html"><strong aria-hidden="true">7.2.13.</strong> Main Summary</a></li><li class="expanded "><a href="../datasets/batch_view/new_profile/reference.html"><strong aria-hidden="true">7.2.14.</strong> New Profile</a></li><li class="expanded "><a href="../datasets/other/socorro_crash/reference.html"><strong aria-hidden="true">7.2.15.</strong> Socorro Crash Reports</a></li><li class="expanded "><a href="../datasets/other/ssl/reference.html"><strong aria-hidden="true">7.2.16.</strong> SSL Ratios (public)</a></li><li class="expanded "><a href="../datasets/batch_view/sync_summary/reference.html"><strong aria-hidden="true">7.2.17.</strong> Sync Summary</a></li><li class="expanded "><a href="../datasets/batch_view/telemetry_aggregates/reference.html"><strong aria-hidden="true">7.2.18.</strong> Telemetry Aggregates</a></li><li class="expanded "><a href="../datasets/batch_view/update/reference.html"><strong aria-hidden="true">7.2.19.</strong> Update</a></li></ol></li><li class="expanded "><a href="../tools/experiments.html"><strong aria-hidden="true">7.3.</strong> Experimental Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/heartbeat.html"><strong aria-hidden="true">7.3.1.</strong> Accessing Heartbeat data</a></li><li class="expanded "><a href="../datasets/shield.html"><strong aria-hidden="true">7.3.2.</strong> Accessing Shield Study data</a></li></ol></li><li class="expanded "><a href="../datasets/search.html"><strong aria-hidden="true">7.4.</strong> Search Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/mozetl/search_aggregates/reference.html"><strong aria-hidden="true">7.4.1.</strong> Search Aggregates</a></li><li class="expanded "><a href="../datasets/mozetl/search_clients_daily/reference.html"><strong aria-hidden="true">7.4.2.</strong> Search Clients Daily</a></li></ol></li><li class="expanded "><a href="../datasets/other.html"><strong aria-hidden="true">7.5.</strong> Other Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/other/hgpush/reference.html"><strong aria-hidden="true">7.5.1.</strong> hgpush</a></li><li class="expanded "><a href="../datasets/other/stub_installer/reference.html"><strong aria-hidden="true">7.5.2.</strong> Stub installer ping</a></li><li class="expanded "><a href="../datasets/other/activity-stream/reference.html"><strong aria-hidden="true">7.5.3.</strong> Activity Stream</a></li></ol></li><li class="expanded "><a href="../datasets/obsolete.html"><strong aria-hidden="true">7.6.</strong> Obsolete Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/obsolete/heavy_users/reference.html"><strong aria-hidden="true">7.6.1.</strong> Heavy Users</a></li><li class="expanded "><a href="../datasets/obsolete/crash_aggregates/reference.html"><strong aria-hidden="true">7.6.2.</strong> Crash Aggregates</a></li><li class="expanded "><a href="../datasets/obsolete/client_count/reference.html"><strong aria-hidden="true">7.6.3.</strong> Client Count</a></li><li class="expanded "><a href="../datasets/obsolete/client_count_daily/reference.html"><strong aria-hidden="true">7.6.4.</strong> Client Count Daily</a></li><li class="expanded "><a href="../datasets/obsolete/retention/reference.html"><strong aria-hidden="true">7.6.5.</strong> Retention</a></li><li class="expanded "><a href="../datasets/obsolete/churn/reference.html"><strong aria-hidden="true">7.6.6.</strong> Churn</a></li></ol></li><li class="expanded "><a href="../datasets/fxa.html"><strong aria-hidden="true">7.7.</strong> Firefox Accounts Datasets</a></li><li><ol class="section"><li class="expanded "><a href="../datasets/fxa_metrics/attribution.html"><strong aria-hidden="true">7.7.1.</strong> Firefox Account Attribution</a></li><li class="expanded "><a href="../datasets/fxa_metrics/funnels.html"><strong aria-hidden="true">7.7.2.</strong> Firefox Account Funnel Metrics</a></li><li class="expanded "><a href="../datasets/fxa_metrics/emails.html"><strong aria-hidden="true">7.7.3.</strong> Firefox Account Email Metrics</a></li><li class="spacer"></li></ol></li></ol></li><li class="expanded "><a href="../concepts/index.html"><strong aria-hidden="true">8.</strong> Telemetry Behavior Reference</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/history.html"><strong aria-hidden="true">8.1.</strong> History of Telemetry</a></li><li class="expanded "><a href="../concepts/profile/index.html"><strong aria-hidden="true">8.2.</strong> Profile Behavior</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/profile/profile_creation.html"><strong aria-hidden="true">8.2.1.</strong> Profile Creation</a></li><li class="expanded "><a href="../concepts/profile/realworldusage.html"><strong aria-hidden="true">8.2.2.</strong> Real World Usage</a></li><li class="expanded "><a href="../concepts/profile/profilehistory.html"><strong aria-hidden="true">8.2.3.</strong> Profile History</a></li></ol></li><li class="expanded "><a href="../concepts/channels/index.html"><strong aria-hidden="true">8.3.</strong> Channel Behavior</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/channels/channel_normalization.html"><strong aria-hidden="true">8.3.1.</strong> Channel Normalization and Querying</a></li></ol></li><li class="expanded "><a href="../concepts/censuses.html"><strong aria-hidden="true">8.4.</strong> Census metrics</a></li><li class="expanded "><a href="../concepts/engagement.html"><strong aria-hidden="true">8.5.</strong> Engagement metrics</a></li><li class="spacer"></li></ol></li><li class="expanded "><a href="../meta/index.html"><strong aria-hidden="true">9.</strong> About this Documentation</a></li><li><ol class="section"><li class="expanded "><a href="../meta/contributing.html"><strong aria-hidden="true">9.1.</strong> Contributing</a></li><li class="expanded "><a href="../meta/structure.html"><strong aria-hidden="true">9.2.</strong> Structure</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Firefox Data Documentation</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><em>Authored by the Product Data Science Team. Please direct questions/concerns to Ben Miroglio (<code>bmiroglio</code>).</em></p>
<h1><a class="header" href="#retention" id="retention">Retention</a></h1>
<p>Retention measures the rate at which users are <em>continuing</em> to use Firefox, making it one of the more important metrics we track. We commonly measure retention between releases, experiment cohorts, and various Firefox subpopulations to better understand how a change to the user experience or use of a specific feature affect behavior.</p>
<h2><a class="header" href="#n-week-retention" id="n-week-retention">N Week Retention</a></h2>
<p>Time is an embedded component of retention. Most retention analysis starts with some anchor, or action that is associated with a date (experiment enrollment date, profile creation date, button clicked on date <em>d</em>, etc.). We then look 1, 2, …, N weeks beyond the anchor to see what percent of users have submitted a ping (signaling their continued use of Firefox).</p>
<p>For example, let’s say we are calculating retention for new Firefox users. Each user can then be anchored by their <code>profile_creation_date</code>, and we can count the number of users who submitted a ping between 7-13 days after profile creation (1 Week retention), 14-20 days after profile creation (2 Week Retention), etc.</p>
<h3><a class="header" href="#example-methodology" id="example-methodology">Example Methodology</a></h3>
<p>Given a dataset in Spark, we can construct a field <code>retention_period</code> that uses <code>submission_date_s3</code> to determine the period to which a ping belongs (i.e. if a user created their profile on April 1st, all pings submitted between April 8th and April 14th are assigned to week 1). 1-week retention can then be simplified to the percent of users with a 1 value for <code>retention_period</code>, 2-week retention simplifies to the percent of users with a 2 value for <code>retention_period</code>, ..., etc. Note that each retention period is independent of the others, so it is possible to have higher 2-week retention than 1-week retention (especially during holidays).</p>
<p>First let's map 1, 2, ..., N week retention the the amount of days elapsed after the anchor point:</p>
<pre><code class="language-python">PERIODS = {}
N_WEEKS = 6
for i in range(1, N_WEEKS + 1):
    PERIODS[i] = {
        'start': i * 7,
        'end': i * 7 + 6
    }  
</code></pre>
<p>Which gives us</p>
<pre><code class="language-python">{1: {'end': 13, 'start': 7},
 2: {'end': 20, 'start': 14},
 3: {'end': 27, 'start': 21},
 4: {'end': 34, 'start': 28},
 5: {'end': 41, 'start': 35},
 6: {'end': 48, 'start': 42}}

</code></pre>
<p>Next, let's define some helper functions:</p>
<pre><code class="language-python">import datetime as dt
import pandas as pd
import pyspark.sql.types as st
import pyspark.sql.functions as F

udf = F.udf

def date_diff(d1, d2, fmt='%Y%m%d'):
    &quot;&quot;&quot;
    Returns days elapsed from d2 to d1 as an integer

    Params:
    d1 (str)
    d2 (str)
    fmt (str): format of d1 and d2 (must be the same)

    &gt;&gt;&gt; date_diff('20170205', '20170201')
    4

    &gt;&gt;&gt; date_diff('20170201', '20170205)
    -4
    &quot;&quot;&quot;
    try:
        return (pd.to_datetime(d1, format=fmt) -
                pd.to_datetime(d2, format=fmt)).days
    except:
        return None


@udf(returnType=st.IntegerType())
def get_period(anchor, submission_date_s3):
    &quot;&quot;&quot;
    Given an anchor and a submission_date_s3,
    returns what period a ping belongs to. This
    is a spark UDF.

    Params:
    anchor (col): anchor date
    submission_date_s3 (col): a ping's submission_date to s3

    Global:
    PERIODS (dict): defined globally based on n-week method

    Returns an integer indicating the retention period
    &quot;&quot;&quot;
    if anchor is not None:
        diff = date_diff(submission_date_s3, anchor)
        if diff &gt;= 7: # exclude first 7 days
            for period in sorted(PERIODS):
                if diff &lt;= PERIODS[period]['end']:
                    return period

@udf(returnType=st.StringType())
def from_unixtime_handler(ut):
    &quot;&quot;&quot;
    Converts unix time (in days) to a string in %Y%m%d format.
    This is a spark UDF.

    Params:
    ut (int): unix time in days

    Returns a date as a string if it is parsable by datetime, otherwise None
    &quot;&quot;&quot;
    if ut is not None:
        try:
            return (dt.datetime.fromtimestamp(ut * 24 * 60 * 60).strftime(&quot;%Y%m%d&quot;))
        except:
            return None

</code></pre>
<p>Now we can load in a subset of <code>main_summary</code> and construct the necessary fields for retention calculations:</p>
<pre><code class="language-python">ms = spark.sql(&quot;&quot;&quot;
    SELECT
        client_id,
        submission_date_s3,
        profile_creation_date,
        os
    FROM main_summary
    WHERE
        submission_date_s3 &gt;= '20180401'
        AND submission_date_s3 &lt;= '20180603'
        AND sample_id = '42'
        AND app_name = 'Firefox'
        AND normalized_channel = 'release'
        AND os in ('Darwin', 'Windows_NT', 'Linux')
    &quot;&quot;&quot;)

PCD_CUTS = ('20180401', '20180415')

ms = (
    ms.withColumn(&quot;pcd&quot;, from_unixtime_handler(&quot;profile_creation_date&quot;)) # i.e. 17500 -&gt; '20171130'
      .filter(&quot;pcd &gt;= '{}'&quot;.format(PCD_CUTS[0]))
      .filter(&quot;pcd &lt;= '{}'&quot;.format(PCD_CUTS[1]))
      .withColumn(&quot;period&quot;, get_period(&quot;pcd&quot;, &quot;submission_date_s3&quot;))
)
</code></pre>
<p>Note that we filter to profiles that were created in the first half of April so that we have sufficient time to observe 6 weeks of behavior. Now we can calculate retention!</p>
<pre><code class="language-python">os_counts = (
    ms
    .groupby(&quot;os&quot;)
    .agg(F.countDistinct(&quot;client_id&quot;).alias(&quot;total_clients&quot;))
)

weekly_counts = (
    ms
    .groupby(&quot;period&quot;, &quot;os&quot;)
    .agg(F.countDistinct(&quot;client_id&quot;).alias(&quot;n_week_clients&quot;))
)

retention_by_os = (
    weekly_counts
    .join(os_counts, on='os')
    .withColumn(&quot;retention&quot;, F.col(&quot;n_week_clients&quot;) / F.col(&quot;total_clients&quot;))
    # Add a 95% confidence interval based on the normal approximation for a binomial distribution,
    # p ± z * sqrt(p*(1-p)/n).
    # The 95% CI spans the range `retention ± ci_95_semi_interval`.
    .withColumn(
      &quot;ci_95_semi_interval&quot;,
      F.lit(1.96) * F.sqrt(F.col(&quot;retention&quot;) * (F.lit(1) - F.col(&quot;retention&quot;)) / F.col(&quot;total_clients&quot;))
    )
)
</code></pre>
<p>Peeking at 6-Week Retention</p>
<pre><code class="language-python">retention_by_os.filter(&quot;period = 6&quot;).show()
</code></pre>
<pre><code>+----------+------+--------------+-------------+-------------------+--------------------+
|        os|period|n_week_clients|total_clients| retention         | ci_95_semi_interval|
+----------+------+--------------+-------------+-------------------+--------------------+
|     Linux|     6|          1495|        22422|0.06667558647756668|0.003265266498407...|
|    Darwin|     6|          1288|         4734|0.27207435572454586|0.012677372722376635|
|Windows_NT|     6|         29024|       124872|0.23243000832852842|0.002342764476746...|
+----------+------+--------------+-------------+-------------------+--------------------+


</code></pre>
<p>we observe that 6.7% ± 0.3% of Linux users whose profile was created in the first half of April submitted a ping 6 weeks later, and so forth. The example code snippets are consolidated in <a href="https://dbc-caf9527b-e073.cloud.databricks.com/#notebook/61351/command/61352">this notebook</a>.</p>
<h3><a class="header" href="#new-vs-existing-user-retention" id="new-vs-existing-user-retention">New vs. Existing User Retention</a></h3>
<p>The above example calculates <strong>New User Retention</strong>, which is distinct from <strong>Existing User Retention</strong>. This distinction is important when understanding retention baselines (i.e. does this number make sense?). Existing users typically have much higher retention numbers than new users.</p>
<p>Note that is more common in industry to refer to Existing User Retention as &quot;Churn&quot; (Churn = 1 - Retention), however, we use retention across the board for the sake of consistency and interpretability.</p>
<p><strong>Please be sure to specify whether or not your retention analysis is for new or existing users.</strong></p>
<h3><a class="header" href="#what-if-theres-no-anchor-point" id="what-if-theres-no-anchor-point">What If There's No Anchor Point?</a></h3>
<p>Sometimes there isn't a clear anchor point like <code>profile_creation_date</code> or <code>enrollment_date</code>.</p>
<p>For example, imagine you are tasked with reporting retention numbers for users that enabled sync (<code>sync_configured</code>) compared to users that haven't. Being a boolean pref, there is no straightforward way to determine <em>when</em> <code>sync_enabled</code> flipped from <code>false</code> to <code>true</code> aside from looking at a client's entire history (which is not recommended!). What now?</p>
<p>We can construct an artificial anchor point using fixed weekly periods; the retention concepts then remain unchanged. The process can be summarized by the following steps:</p>
<ul>
<li>Define a baseline week cohort
<ul>
<li>For this example let's define the baseline as users that submitted pings between 2018-01-01 and 2018-01-07</li>
</ul>
</li>
<li>Count all users with/without sync enabled in this period</li>
<li>Assign these users to an anchor point of 2018-01-01 (the <strong>beginning</strong> of the baseline week)</li>
<li>Count the number of users in the baseline week that submitted a ping between 7-13 days after 2018-01-01 (1 Week retention), 14-20 days after 2018-01-01 (2 Week Retention), etc.</li>
<li>Shift the baseline week up 7 days (and all other dates) and repeat as necessary</li>
</ul>
<p>This method is also valid in the presence of an anchor point, however, it is recommended the anchor point method is employed when possible.</p>
<h3><a class="header" href="#confounding-factors" id="confounding-factors">Confounding Factors</a></h3>
<p>When performing retention analysis between two or more groups, it is important to look at other usage metrics to get an understanding of other influential factors.</p>
<p>For example (borrowing the sync example from the previous section) you find that users with and without sync have a 1 week retention of 0.80 and 0.40, respectively. Wow--we should really be be promoting sync as it could double retention numbers!</p>
<p><em>Not quite</em>. Turns out you next look at <code>active_ticks</code> and <code>total_uri_count</code> and find that sync users report much higher numbers for these measures as well. Now how can we explain this difference in retention?</p>
<p>There could be an entirely separate cookbook devoted to answering this question, however this contrived example is meant to demonstrate that simply comparing retention numbers between two groups isn't capturing the full story. Sans an experiment or model-based approach, all we can say is &quot;enabling sync is <strong>associated</strong> with higher retention numbers.&quot; There is still value in this assertion, however it should be stressed that <strong>association/correlation != causation!</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../cookbooks/active_dau.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../datasets/new_data.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../cookbooks/active_dau.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../datasets/new_data.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../mermaid.min.js"></script>
        
        <script type="text/javascript" src="../mermaid-init.js"></script>
        

        

    </body>
</html>
